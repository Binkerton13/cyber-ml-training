# Workflow: evaluate submissions
name: Evaluate Student Submission

on:
  push:
    paths:
      - "student_submissions/**"

jobs:
  evaluate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas scikit-learn

    - name: Locate student submission
      id: find_files
      run: |
        # Find scenario folder (e.g., scenario_01, scenario_02, scenario_03, etc.)
        SCENARIO=$(find student_submissions -maxdepth 2 -type d -name "scenario_*" | head -n 1)
        echo "SCENARIO=$SCENARIO" >> $GITHUB_ENV

        # Find SOC + ML outputs
        echo "SOC_FILE=$(find $SCENARIO -name soc_output.json)" >> $GITHUB_ENV
        echo "ML_FILE=$(find $SCENARIO -name ml_output.json)" >> $GITHUB_ENV

    - name: Evaluate SOC Output
      run: |
        python scenarios/$(basename $SCENARIO)/evaluation/evaluate_soc.py \$SOC_FILE \scenarios/$(basename $SCENARIO)/evaluation/answer_key.json \> soc_result.json

    - name: Evaluate ML Output
      run: |
        python scenarios/$(basename $SCENARIO)/evaluation/evaluate_ml.py \$ML_FILE \scenarios/$(basename $SCENARIO)/evaluation/answer_key.json \> ml_result.json

    - name: Evaluate Combined Output
      run: |
        python scenarios/$(basename $SCENARIO)/evaluation/evaluate_combined.py \$SOC_FILE \$ML_FILE \scenarios/$(basename $SCENARIO)/evaluation/answer_key.json \> combined_result.json

    - name: Combine evaluation results
      run: |
        mkdir -p evaluation_results
        python - << 'EOF'
        import json

        soc = json.load(open("soc_result.json"))
        ml = json.load(open("ml_result.json"))
        combined = json.load(open("combined_result.json"))

        output = {
            "scenario": "${SCENARIO}",
            "soc": soc,
            "ml": ml,
            "combined": combined,
            "total_score": soc["soc_score"] + ml["ml_score"] + combined["combined_score"]
        }

        with open("evaluation_results/evaluation_output.json", "w") as f:
            json.dump(output, f, indent=4)
        EOF

    - name: Save evaluation results
      run: |
        mkdir -p evaluation_results
        cp evaluation_results/evaluation_output.json evaluation_results/

    - name: Commit evaluation results
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Add evaluation results"
        file_pattern: "evaluation_results/evaluation_output.json"
